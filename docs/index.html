<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--<script src="jquery.min.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

    <style>
        body,
        html {
            height: 100%;
            background-color: #00dcff0f;
            width: 100%;
            margin: 0px;
            position:fixed;
        }
        .centre {
            width: 50px;
            height: 50px;
            position: relative;
            top: 50%;
            left: 50%;
        }
    </style>
</head>
<body>
<div style="height:90%">
    ttt
    <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
    <canvas id="myChart2" style="width:100%;max-width:700px"></canvas>
</div>
</body>
</html>
<script>
    var ips = [];
    var lsscan = true;
    for (var j = 0; j <= 256; j++) {
        var ls = localStorage.getItem(j);
        if (ls && JSON.parse(ls)){
            //DEBUG alert
            //alert('found:' + ls);
            var pls = JSON.parse(ls);
            if (pls['type']) {
                lsscan = false;
                delayedRequest(j);
            }
        }
    }
    function scan(){
        var hrf = "http://192.168.0.";
        var cur_url = '';
        var j = 1;


        for (var i = 170; i <= 176; i++) {
            cur_url = hrf + i;
            ips[cur_url] = '0';
            $.ajax({url: cur_url + '/info', type: "GET",
                success: function(result){
                    let u = this.url.slice(0, -5);
                    ips[u] = '1';
                    localStorage.setItem(j, '{"id" : "'+ j +'", "dataid" : "data' + j + '", "type" : "sensor", "position" : "room", "refresh" : "60000", "requestURL" : "'+ u +'/sensor"}');
                    localStorage.setItem('data' + j, '[]');
                    delayedRequest(j);
                    ++j;
                },
                error: function(result){
                    //alert( "finished" );
                    //$.each(result, function(index, el)
                    //{
                        //alert(index);
                        //alert(el);
                    //});
                },
                timeout: 3000 // sets timeout to 3 seconds
            });
        }
        //console.log(ips);
    };
    if (lsscan) {
        scan();
    }

    //this function add data to LS
    function addDataToLS(){
        //localStorage.setItem('');
    }

    var timeoutID;
    var tArray = [];
    var hArray = [];

    function delayedRequest(item) {
        let curItem = JSON.parse(localStorage.getItem(item));
        //console.log(curItem['refresh']);
        timeoutID = setInterval(slowAlert, curItem['refresh'], curItem);
    }

    function slowAlert(curItem) {
        $.ajax({url: curItem['requestURL'], type: "GET",
            success: function(result){
                let dataArray = JSON.parse(localStorage.getItem(curItem['dataid']));
                if(dataArray == null) dataArray = [];
                if(hArray == null) hArray = [];
                if(tArray == null) tArray = [];

                var resultArray = JSON.parse(result);
                resultArray['time'] = Math.floor(Date.now() / 1000);
                dataArray.push(resultArray);
                //console.log(dataArray);
                localStorage.setItem(curItem['dataid'], JSON.stringify(dataArray));

                //dataArray.forEach(function(item){
                //    tArray.push({'x': item['time'], 'y': item['t']});
                //    hArray.push({'x': item['time'], 'y': item['h']});
                //})

                if (resultArray['t']) {
                    //t
                    tArray.push({'x': Math.floor(Date.now() / 1000), 'y': resultArray['t']});
                    printChart(tArray, 'myChart');
                    //h
                    hArray.push({'x': Math.floor(Date.now() / 1000), 'y': resultArray['h']});
                    printChart(hArray, 'myChart2');
                }
            },
            error: function(result){
            },
            timeout: 3000 // sets timeout to 3 seconds
        });
    }

    function printChart(xyArray, ch) {
        new Chart(ch, {
            type: "scatter",
            data: {
                datasets: [{
                    pointRadius: 4,
                    pointBackgroundColor: "rgba(0,0,255,1)",
                    data: xyArray
                }]
            },
            options: {}
        });
    }
</script>
